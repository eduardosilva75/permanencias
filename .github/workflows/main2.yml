name: Build Windows Executable

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:  # Permite acionar manualmente

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        architecture: 'x64'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyInstaller
        pip install PyQt5
        pip install pandas
        pip install openpyxl
        pip install pyinstaller

    - name: Verify files exist
      run: |
        dir *.py
        dir *.xlsx
        dir *.db

    - name: Build with PyInstaller
      run: |
        pyinstaller --onefile `
          --windowed `
          --name="EscalaPermanencias" `
          --hidden-import=pandas `
          --hidden-import=numpy `
          --hidden-import=openpyxl `
          --hidden-import=PyQt5.sip `
          --hidden-import=PyQt5.QtCore `
          --hidden-import=PyQt5.QtGui `
          --hidden-import=PyQt5.QtWidgets `
          --hidden-import=sqlite3 `
          --hidden-import=datetime `
          --hidden-import=collections `
          --add-data="escala_folgas.xlsx;." `
          --add-data="escala_permanencias.db;." `
          --clean `
          main.py

    - name: List dist contents
      run: dir dist\

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: EscalaPermanencias-Windows
        path: dist/EscalaPermanencias.exe
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/EscalaPermanencias.exe
        body: |
          ExecutÃ¡vel Windows para o Sistema de GestÃ£o de Escalas
          
          **Funcionalidades:**
          - ðŸ“… Gerar escalas automaticamente
          - ðŸ‘¥ Fixar pessoas em datas especÃ­ficas
          - âž• Adicionar/editar pessoas
          - ðŸ’¾ Exportar para Excel
          
          **Requisitos:**
          - Windows 10/11
          - NÃ£o necessita de Python instalado
